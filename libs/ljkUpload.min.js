(function(win,$){var LjkUpload=function(root,message){this.element=root;var defaultsMessage={notice:this.notice};this.message=$.extend(defaultsMessage,message);this.errorNotice=this.message.notice};LjkUpload.prototype={files:null,scale:1.0,maxScale:3.0,range:0.05,fileTypeConfig:{"img":"图片","file":"文件"},isPc:(function(nav){var userAgent=nav.userAgent;var AgentsArray=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];var flag=true;for(var i=0;i<AgentsArray.length;i++){if(userAgent.indexOf(AgentsArray[i])>-1){flag=false;break}}return flag})(navigator),loading:function(msg){msg=msg?msg:'请稍后';var list="";for(var i=1;i<=12;i++){list+="<div class='sk-circle"+i+" sk-child'></div>"}var doms=$(""+"<div class='removeLoading ljkPopup modal' style='display: block'><div class='mask'><div class='loading'>"+"<div class='sk-circle'>"+list+"</div><p class='text-center fz18 color-white mt30'>"+msg+"</p></div></div>");$("body").append(doms)},notice:function(msg,showTime,onHideHandler,title){title=title?title:'提示';var $dom=$('<div class="ljkPopup modal" style="display:block"><div class="mask"></div><div class="ljkPopup-wrap modal-wrap ctrl-modal"><div class="modal-title"><h2 class="none">'+title+'</h2></div><table><tr><td><h1 class="none mt20">'+msg+'</h1></td></tr></table></div></div>');$('body').append($dom);if(typeof showTime=='undefined'){showTime=1500}else{showTime=Math.max(parseInt(showTime),1500)}var i=setTimeout(function(){clearTimeout(i);setTimeout(function(){$dom.remove();if(typeof(onHideHandler)=='function'){onHideHandler()}},500);$dom.css('opacity',0)},showTime)},removeLoading:function(){$('.removeLoading').remove()},selectImg:function(options){if(typeof options!="object"){return}options.fileSelectBtn?options.fileSelectBtn.on("click",function(){options.fileBtn.click()}):options.fileBtn.click()},getBoundingClientRect:function(ele){const gbc=ele.getBoundingClientRect();return{left:gbc.left,top:gbc.top}},moveImage:function(options){if(typeof options!="object"){return}var isPc=this.isPc;var mouseOffsetX=0,mouseOffsetY=0,isDown=false;options.ele.on(isPc?"mousedown":"touchstart",function(e){var touche=isPc?e:(e.originalEvent.targetTouches[0]||e.targetTouches[0]);isDown=true;mouseOffsetX=touche.pageX-~~(this.getBoundingClientRect(options.ele.get(0)).left);mouseOffsetY=touche.pageY-~~(this.getBoundingClientRect(options.ele.get(0)).top)});options.ele.on(isPc?"mousemove":"touchmove",function(e){e.preventDefault();var mouseX=0,mouseY=0;var touche=isPc?e:(e.originalEvent.touches[0]||e.originalEvent.changedTouches[0]||e.targetTouches[0]);if(isDown===true){mouseX=touche.pageX-mouseOffsetX;mouseY=touche.pageY-mouseOffsetY;options.ele.css({top:mouseY+"px",left:mouseX+"px"})}});options.ele.on(isPc?"mouseup":"touchend",function(e){e.preventDefault();isDown=false});options.ele.on(isPc?"mouseout":"touchcancel",function(e){e.preventDefault();isDown=false})},showImage:function(options){var defaults={maxSize:1024,zoom:false};var options=$.extend(defaults,options);if(typeof options!="object"){return}var _this=this;_this.selectImg(options);_this.getFileInfo(options.fileBtn,options.maxSize,_this.fileTypeConfig['img'],function(data){_this.resetScale(options.range,options.showEle);_this.appendImage(data.result,options.fileSelectBtn,options.showEle,function(result){options.callback&&options.callback(result)});options.zoom&&_this.bindMouseWheel(options.range,options.showEle);options.fileBtn.blur()})},resetScale:function(range,showEle){range&&range.val(1.0);this.ToScale(showEle,1.0)},appendImage:function(result,fileSelectBtn,showEle,callback){this.loadImage(result).then(image=>{fileSelectBtn&&fileSelectBtn.addClass("success-linear");showEle.html('').append(image).removeClass("hasImg");callback&&callback(result)}).catch(e=>{throw new Error(e)})},bindMouseWheel:function(rangeEle,showEle){var _this=this;var scale=_this.scale,maxScale=_this.maxScale,range=_this.range;showEle.get(0).onmousewheel=function(e){var target,ee=e||window.event;target=ee.delta?ee.delta:ee.wheelDelta;if(target>0){scale+=range;scale=Math.min(scale,maxScale);rangeEle&&rangeEle.val(scale);_this.ToScale(showEle,scale)}else if(target<0){scale-=range;scale=Math.max(0,scale);rangeEle&&rangeEle.val(scale);_this.ToScale(showEle,scale)}else{return false}}},getFileInfo:function(fileBtn,maxSize,fileType,callback){var _this=this;fileType=fileType||_this.fileTypeConfig['file'];fileBtn.on('change',function(){if(!window.FileReader){_this.errorNotice("浏览器版本过低");return};_this.files=Array.prototype.slice.call(this.files);_this.filterFileInfo(_this.files,fileType,maxSize,function(data){callback(data)})})},filterFileInfo:function(fileList,fileType,maxSize,callback){var _this=this;if(fileList.length&&fileList.length>1){fileType==_this.fileTypeConfig['img']?_this.errorNotice("只能上传1张图片:)"):_this.errorNotice("只能上传1个文件:)");return}fileList.forEach(function(file,i){if(fileType==_this.fileTypeConfig['img']){var reg=/\/(?:jpeg|jpg|png|gif)/i;var type=file.type.split("/").pop();if(!reg.test(file.type)){_this.errorNotice("不支持"+type+"格式的"+fileType+"哟");return}}if(maxSize!='undefined'&&typeof maxSize=='number'){var fileSize=file.size/1024;if(fileSize>maxSize){_this.errorNotice("抱歉,"+fileType+" 最大为 "+maxSize+" KB");return}}var reader=new FileReader();reader.onprogress=function(){_this.loading("读取中,请稍后")};reader.onerror=function(){_this.removeLoading();_this.errorNotice("读取失败")};reader.onabort=function(){_this.removeLoading();_this.errorNotice("网络异常!")};reader.onload=function(){_this.removeLoading();var result=this.result;callback&&callback({name:file.name,type:file.type,size:file.size,result:result})};reader.readAsDataURL(file);})},loadImage:function(src){return new Promise((res,rej)=>{let img=new Image();img.src=src;img.onload=()=>{res(img)};img.onerror=(e)=>{rej(e)}})},rangeToScale:function(options){if(typeof options!="object"){return}var _this=this;var isPc=this.isPc;var scale=_this.scale;options.range.on(isPc?"mousemove ":"touchmove",function(e){var _this_=$(this);scale=Number(_this_.val());options.range&&options.range.val(scale);_this.ToScale(options.ele,scale)}).prev().on(isPc?"mouseover ":"touchstart",function(){scale-=0.01;options.range&&options.range.val(scale);_this.ToScale(options.ele,scale)}).next().next().on(isPc?"mouseover":"touchstart",function(){scale+=0.01;options.range&&options.range.val(scale);_this.ToScale(options.ele,scale)})},ToScale:function(ele,scale){ele.css({"-webkit-transform":"scale("+scale+")","-moz-transform":"scale("+scale+")","-ms-transform":"scale("+scale+")","-o-transform":"scale("+scale+")","transform":"scale("+scale+")"})},clipImage:function(options){var _this=this;if(typeof options!="object"){return};var defaults={uploadBtn:$(".upload-upload-btn"),uploadImageBox:$(".move-image"),clipImage:$(".clip-image"),range:$("#range")};var options=$.extend(defaults,options);_this.canvas=document.createElement("canvas");options.uploadBtn.on("click",function(){try{if(options.uploadImageBox.hasClass("hasImg")){_this.errorNotice("请选择图片");return}var $img=options.uploadImageBox.find("img"),cxt=_this.canvas.getContext("2d"),$width=options.clipImage.width(),$height=options.clipImage.height();_this.canvas.width=$width;_this.canvas.height=$height;var scale=options.range.val()||options.range.value,sx=~~(options.clipImage.offset().left-options.uploadImageBox.offset().left),sy=~~(options.clipImage.offset().top-options.uploadImageBox.offset().top);cxt.drawImage($img.get(0),sx/ scale, sy /scale,$width/ scale, $height /scale,0,0,$width,$height);var imageType=(options.quality&&typeof(options.quality)==='number')?'image/jpeg':'image/png';var Src=_this.canvas.toDataURL(imageType,Number(options.quality));delete this.canvas;if(typeof options.clipSuccess!="function"){throw new Error("请使用clipSuccess回调函数:(")};options.clipSuccess(Src)}catch(e){options.clipError('error:'+e)}})},clipUpload:function(options){var defaults={maxSize:1024,drag:true,zoom:true,dragAreaActiveClassName:"dragActive",success:function(){},error:function(){}};var options=$.extend(defaults,options);this.moveImage({ele:options.showEle});this.showImage({range:options.range,fileSelectBtn:options.fileSelectBtn,fileBtn:options.fileBtn,showEle:options.showEle,maxSize:options.maxSize,zoom:options.zoom});this.rangeToScale({range:options.range,ele:options.showEle});this.clipImage({range:options.range,quality:options.quality,clipSuccess:function(Src){options.success(Src)},clipError:function(e){options.error(e)}});options.drag===true&&options.dragArea&&this.addListener({type:this.fileTypeConfig['img'],fileBtn:options.fileBtn,dragArea:options.dragArea,fileArea:options.showEle,maxSize:options.maxSize,range:options.range,dragAreaActiveClassName:options.dragAreaActiveClassName})},uploadFile:function(fileUploadBtn,form,url,attr,progressCallback,errCallback,successCallback){var xhr=new XMLHttpRequest();fileUploadBtn.on('click',function(){var formData=form?new FormData(form[0]):new FormData();if(attr){var key=Object.keys(attr)[0];!form&&attr&&formData.append(Object.keys(attr)[0],attr[key])}xhr.onloadstart=function(){console.log("load start")};xhr.onerror=function(e){errCallback&&errCallback(e)};xhr.onload=function(){var result=JSON.parse(xhr.responseText);successCallback&&successCallback(result)};xhr.onabort=function(event){_this.errorNotice('传输中断!')};xhr.ontimeout=function(){_this.errorNotice('连接超时!')};xhr.onloadend=function(){console.log('传输结束')};xhr.upload.onprogress=function(e){var progress=Math.round(e.loaded*100/e.total);progressCallback&&progressCallback(progress)};xhr.open('POST',url,true);xhr.send(formData)})},fileUpload:function(options){var defaults={maxSize:1024,onChange:function(){},progress:function(){},error:function(){},success:function(){}};var options=$.extend(defaults,options);var _this=this;if(!options.url)throw new Error('No upload address specified');_this.selectImg(options);_this.getFileInfo(options.fileBtn,options.maxSize,_this.fileTypeConfig['file'],function(result){options.onChange&&options.onChange(result);_this.uploadFile(options.fileUploadBtn,options.form,options.url,undefined,options.progress,options.error,options.success)});options.drag===true&&options.dragArea&&_this.addListener($.extend(options,{type:_this.fileTypeConfig['file']}))},addDragAreaStyle:function(ele,className){ele.addClass(className||'dragActive')},removeDragAreaStyle:function(ele,className){ele.removeClass(className||'dragActive')},stopAll:function(e){e.preventDefault();e.stopPropagation();},addListener:function(options){var defaults={zoom:true,type:this.fileTypeConfig['img'],dragAreaActiveClassName:"dragActive"};var options=$.extend(defaults,options);var $dragArea=options.dragArea;var dragAreaClassName=options.dragAreaActiveClassName;var dragArea=$dragArea.get(0);var _this=this;document.addEventListener('dragenter',function(e){_this.addDragAreaStyle($dragArea,dragAreaClassName)},false);document.addEventListener('dragleave',function(){_this.removeDragAreaStyle($dragArea,dragAreaClassName)},false);dragArea.addEventListener('dragenter',function(e){_this.stopAll(e);_this.addDragAreaStyle($dragArea,dragAreaClassName)},false);dragArea.addEventListener('dragleave',function(e){_this.stopAll(e);_this.removeDragAreaStyle($dragArea,dragAreaClassName)},false);dragArea.addEventListener('dragover',function(e){(e.dataTransfer||e.originalEvent.dataTransfer).dropEffect='copy';_this.stopAll(e);_this.addDragAreaStyle($dragArea,dragAreaClassName)},false);dragArea.addEventListener('drop',function(e){_this.stopAll(e);_this.removeDragAreaStyle($dragArea);var files=(e.dataTransfer||e.originalEvent.dataTransfer).files;_this.filterFileInfo(Array.from(files),options.type,options.maxSize,function(data){if(options.type==_this.fileTypeConfig['img']){_this.resetScale(options.range,options.fileArea);_this.appendImage(data.result,options.fileSelectBtn,options.fileArea);options.zoom===true&&_this.bindMouseWheel(options.range,options.fileArea)}else{var formData={};formData[options.fileBtn.attr("name")]=files[0];options.onChange&&options.onChange(data);_this.uploadFile(options.fileUploadBtn,undefined,options.url,formData,options.progress,options.error,options.success)}})},false)},fileTypeRegExp:function(fileType,reg){let regExp=new RegExp('.*\/(?:'+fileType+')$','i');return regExp.test(reg)}};win['LjkUpload']=LjkUpload})(window,jQuery);