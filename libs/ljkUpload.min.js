(function(t,a){var n=function(e,t){this.element=e;var n={notice:this.notice};this.message=a.extend(n,t);this.errorNotice=this.message.notice};n.prototype={files:null,scale:1,maxScale:3,range:.05,fileSize:0,multipleNum:0,fileTypeConfig:{img:"图片",file:"文件"},isPc:function(e){var t=e.userAgent;var a=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];var n=true;for(var i=0;i<a.length;i++){if(t.indexOf(a[i])>-1){n=false;break}}return n}(navigator),loading:function(e){e=e?e:"请稍后";var t="";for(var n=1;n<=12;n++){t+="<div class='sk-circle"+n+" sk-child'></div>"}var i=a(""+"<div class='removeLoading ljkPopup modal' style='display: block'><div class='mask'><div class='loading'>"+"<div class='sk-circle'>"+t+"</div><p class='text-center fz18 color-white mt30'>"+e+"</p></div></div>");a("body").append(i)},notice:function(e,t,n,i){i=i?i:"提示";var r=a('<div class="ljkPopup modal" style="display:block"><div class="mask"></div><div class="ljkPopup-wrap modal-wrap ctrl-modal"><div class="modal-title"><h2 class="none">'+i+'</h2></div><table><tr><td><h1 class="none mt20">'+e+"</h1></td></tr></table></div></div>");a("body").append(r);if(typeof t=="undefined"){t=1500}else{t=Math.max(parseInt(t),1500)}var o=setTimeout(function(){clearTimeout(o);setTimeout(function(){r.remove();if(typeof n=="function"){n()}},500);r.css("opacity",0)},t)},removeLoading:function(){a(".removeLoading").remove()},selectImg:function(e){if(typeof e!="object"){return}e.fileSelectBtn?e.fileSelectBtn.on("click",function(){e.fileBtn.click()}):e.fileBtn.click()},getBoundingClientRect:function(e){var t=e.getBoundingClientRect();return{left:t.left,top:t.top}},moveImage:function(e){if(typeof e!="object"){return}var t=this.isPc;var a=0,n=0,i=false;e.ele.on(t?"mousedown":"touchstart",function(r){var o=t?r:r.originalEvent.targetTouches[0]||r.targetTouches[0];i=true;a=o.pageX-~~this.getBoundingClientRect(e.ele.get(0)).left;n=o.pageY-~~this.getBoundingClientRect(e.ele.get(0)).top});e.ele.on(t?"mousemove":"touchmove",function(r){r.preventDefault();var o=0,l=0;var s=t?r:r.originalEvent.touches[0]||r.originalEvent.changedTouches[0]||r.targetTouches[0];if(i===true){o=s.pageX-a;l=s.pageY-n;e.ele.css({top:l+"px",left:o+"px"})}});e.ele.on(t?"mouseup":"touchend",function(e){e.preventDefault();i=false});e.ele.on(t?"mouseout":"touchcancel",function(e){e.preventDefault();i=false})},showImage:function(e){var t={maxSize:1024,zoom:false};var e=a.extend(t,e);if(typeof e!="object"){return}var n=this;n.selectImg(e);n.getFileInfo(e.fileBtn,e.maxSize,n.fileTypeConfig["img"],false,function(t){n.resetScale(e.range,e.showEle);n.appendImage(t.result,e.fileSelectBtn,e.showEle,function(t){e.callback&&e.callback(t)});e.zoom===true&&n.bindMouseWheel(e.range,e.showEle);e.fileBtn.blur()})},resetScale:function(e,t){e&&e.val(1);this.ToScale(t,1)},appendImage:function(e,t,a,n){this.loadImage(e).then(function(i){t&&t.addClass("success-linear");a.html("").append(i).removeClass("hasImg");n&&n(e)}).catch(function(e){this.errorNotice("添加图片节点出错!");throw new Error(e)})},bindMouseWheel:function(e,t){var a=this;var n=a.scale,i=a.maxScale,r=a.range;t.get(0).onmousewheel=function(o){var l,s=o||window.event;l=s.delta?s.delta:s.wheelDelta;if(l>0){n+=r;n=Math.min(n,i);e&&e.val(n);a.ToScale(t,n)}else if(l<0){n-=r;n=Math.max(0,n);e&&e.val(n);a.ToScale(t,n)}else{return false}}},getFileInfo:function(e,t,a,n,i){var r=this;a=a||r.fileTypeConfig["file"];e.on("change",function(){if(!window.FileReader){r.errorNotice("浏览器版本过低");return}r.files=Array.prototype.slice.call(this.files);r.filterFileInfo(r.files,a,t,n,function(e){i(e)})})},filterFileInfo:function(e,t,a,n,i){var r=this;n=n||false;if(!n){if(e.length&&e.length>1){t==r.fileTypeConfig["img"]?r.errorNotice("只能上传1张图片:)"):r.errorNotice("只能上传1个文件:)");return}}e.forEach(function(e,n){r.readerImage(t,e,a,function(e){i(e)})})},readerImage:function(e,t,a,n){var i=this;if(e==i.fileTypeConfig["img"]){var r=/\/(?:jpeg|jpg|png|gif)/i;var o=t.type.split("/").pop();if(!r.test(t.type)){i.errorNotice("不支持"+(!!o?o:"这种")+"格式的"+(!!o?e:"文件")+"哟");return}}if(a!="undefined"&&typeof a=="number"){var l=t.size/1024;if(l>a){i.errorNotice("抱歉,"+e+" 最大为 "+a+" KB");return}}var s=new FileReader;s.onprogress=function(){i.loading("读取中,请稍后")};s.onerror=function(){i.removeLoading();i.errorNotice("读取失败")};s.onabort=function(){i.removeLoading();i.errorNotice("网络异常!")};s.onload=function(){i.removeLoading();var e=this.result;n&&n({name:t.name,type:t.type,size:t.size,result:e})};s.readAsDataURL(t)},loadImage:function(t){return new Promise(function(a,n){var i=new Image;i.src=t;i.onload=function(){a(i)};i.onerror=function(){n(e)}})},rangeToScale:function(e){if(typeof e!="object"){return}var t=this;var n=this.isPc;var i=t.scale;e.range.on(n?"mousemove ":"touchmove",function(n){var r=a(this);i=Number(r.val());e.range&&e.range.val(i);t.ToScale(e.ele,i)}).prev().on(n?"mouseover ":"touchstart",function(){i-=.01;e.range&&e.range.val(i);t.ToScale(e.ele,i)}).next().next().on(n?"mouseover":"touchstart",function(){i+=.01;e.range&&e.range.val(i);t.ToScale(e.ele,i)})},ToScale:function(e,t){e.css({"-webkit-transform":"scale("+t+")","-moz-transform":"scale("+t+")","-ms-transform":"scale("+t+")","-o-transform":"scale("+t+")",transform:"scale("+t+")"})},clipImage:function(e){var t=this;if(typeof e!="object"){return}var n={uploadBtn:a(".upload-upload-btn"),uploadImageBox:a(".move-image"),clipImage:a(".clip-image"),range:a("#range")};var e=a.extend(n,e);t.canvas=document.createElement("canvas");e.uploadBtn.on("click",function(){try{if(e.uploadImageBox.hasClass("hasImg")){t.errorNotice("请选择图片");return}var a=e.uploadImageBox.find("img"),n=t.canvas.getContext("2d"),i=e.clipImage.width(),r=e.clipImage.height();t.canvas.width=i;t.canvas.height=r;var o=e.range.val()||e.range.value,l=~~(e.clipImage.offset().left-e.uploadImageBox.offset().left),s=~~(e.clipImage.offset().top-e.uploadImageBox.offset().top);n.drawImage(a.get(0),l/o,s/o,i/o,r/o,0,0,i,r);var c=e.quality&&typeof e.quality==="number"?"image/jpeg":"image/png";var f=t.canvas.toDataURL(c,Number(e.quality));delete this.canvas;if(typeof e.clipSuccess!="function"){throw new Error("请使用clipSuccess回调函数:(")}e.clipSuccess(f)}catch(t){e.clipError("error:"+t)}})},clipUpload:function(e){var t={maxSize:1024,drag:true,zoom:true,paste:true,dragAreaActiveClassName:"dragActive",success:function(){},error:function(){}};var n=this;var e=a.extend(t,e);this.moveImage({ele:e.showEle});this.showImage({range:e.range,fileSelectBtn:e.fileSelectBtn,fileBtn:e.fileBtn,showEle:e.showEle,maxSize:e.maxSize,zoom:e.zoom});this.rangeToScale({range:e.range,ele:e.showEle});this.clipImage({range:e.range,quality:e.quality,clipSuccess:function(t){e.success(t)},clipError:function(t){e.error(t)}});e.drag===true&&e.dragArea&&this.addListener({type:this.fileTypeConfig["img"],fileBtn:e.fileBtn,dragArea:e.dragArea,fileArea:e.showEle,maxSize:e.maxSize,range:e.range,dragAreaActiveClassName:e.dragAreaActiveClassName,callback:function(t){n.appendImage(t.result,e.fileSelectBtn,e.showEle)}});e.paste===true&&this.addPasteListener(function(t){n.readerImage(n.fileTypeConfig["img"],t,e.maxSize,function(t){n.appendImage(t.result,e.fileSelectBtn,e.showEle);e.zoom===true&&n.bindMouseWheel(e.range,e.showEle)})})},addPasteListener:function(e){var t=this;a(document.body).on("paste",function(a){var n=window.clipboardData||a.originalEvent.clipboardData;var i=n.items;var r=n.types||[];if(!i)return;var o=i[0],l=o.kind,s=o.type;if(l.toLocaleLowerCase()!="file")return t.errorNotice("文件类型不正确！");e&&e(o.getAsFile())})},uploadFile:function(e,t,a,n,i,r,o){var l=new XMLHttpRequest;e.on("click",function(){var e=t?new FormData(t[0]):new FormData;if(n){var s=Object.keys(n)[0];!t&&n&&e.append(Object.keys(n)[0],n[s])}l.onloadstart=function(){console.log("开始上传...")};l.onerror=function(e){_this.errorNotice("上传失败!");r&&r(e)};l.onload=function(){var e=JSON.parse(l.responseText);o&&o(e)};l.onabort=function(e){_this.errorNotice("上传中断!")};l.ontimeout=function(){_this.errorNotice("连接超时!")};l.onloadend=function(){console.log("传输结束")};l.upload.onprogress=function(e){console.info("上传中...");var t=Math.round(e.loaded*100/e.total);i&&i(t)};l.open("POST",a,true);l.send(e)})},fileUpload:function(e){var t={maxSize:1024,onChange:function(){},progress:function(){},error:function(){},success:function(){}};var e=a.extend(t,e);var n=this;if(!e.url)throw new Error("No upload address specified");n.selectImg(e);n.getFileInfo(e.fileBtn,e.maxSize,n.fileTypeConfig["file"],false,function(t){e.onChange&&e.onChange(t);n.uploadFile(e.fileUploadBtn,e.form,e.url,undefined,e.progress,e.error,e.success)});e.drag===true&&e.dragArea&&n.addListener(a.extend(e,{type:n.fileTypeConfig["file"]}))},bindmultipleEvent:function(e,t,a,n,i,r){var o=this,l=~~(t.size/1024);var s=o.createMultipleItem(++e,l);i.append(s.item);o.appendImage(t.result,n,s.warp);o.multipleSizeChange(r,t,l,1,true);o.removeMultipleItem(s.remove,function(){o.multipleSizeChange(r,t,l,o.multipleNum,false)});a.blur()},multipleUpload:function(e){var t={maxSize:1024,drag:true,paste:true,multipleSection:a(".multiple-list"),dragAreaActiveClassName:"multiple-area-active",onChange:function(){}};var n=e.multipleSection;var e=a.extend(t,e);var i=this;var r=0;i.selectImg(e);i.getFileInfo(e.fileBtn,e.maxSize,i.fileTypeConfig["img"],true,function(t){i.bindmultipleEvent(r,t,e.fileBtn,e.fileSelectBtn,n,e.onChange)});e.paste===true&&this.addPasteListener(function(t){i.readerImage(i.fileTypeConfig["img"],t,e.maxSize,function(t){i.bindmultipleEvent(r,t,e.fileBtn,e.fileSelectBtn,n,e.onChange)})});if(e.drag===true&&e.dragArea){i.addListener(a.extend(e,{zoom:false,type:i.fileTypeConfig["file"],callback:function(t){i.bindmultipleEvent(r,t,e.fileBtn,e.fileSelectBtn,n,e.onChange)}}))}e.uploadBtn&&e.uploadBtn.on("click",function(){if(i.multipleNum<=0||i.allFileSize<=0){return i.errorNotice("请选择文件!")}})},multipleSizeChange:function(e,t,n,i,r){e&&e(a.extend(t,{allFileSize:r?this.fileSize+=n:this.fileSize-=n,size:n,multipleNum:r?this.multipleNum+=i:this.multipleNum-=1}))},removeMultipleItem:function(e,t){var n=this;e.on("click",function(){var e=a(this),n=a(this).data("id"),i=a(this).data("size");a("#upload-"+n).remove();t&&t()})},createMultipleItem:function(e,t){t=!!t||0;var n=a('<li class="multiple-item" id="upload-'+e+'"><div class="mask"><a href="javascript:;" data-id="'+e+'" data-size="'+t+'">删除</a></div><div class="item-warp hasImg"></div></li>');return{item:n,warp:n.find(".item-warp"),mask:n.find(".mask"),remove:n.find("a")}},addDragAreaStyle:function(e,t){e.addClass(t||"dragActive")},removeDragAreaStyle:function(e,t){e.removeClass(t||"dragActive")},stopAll:function(e){e.preventDefault();e.stopPropagation()},addListener:function(e){var t={zoom:true,type:this.fileTypeConfig["img"],dragAreaActiveClassName:"dragActive"};var e=a.extend(t,e);var n=e.dragArea;var i=e.dragAreaActiveClassName;var r=n.get(0);var o=this;document.addEventListener("dragenter",function(e){o.addDragAreaStyle(n,i)},false);document.addEventListener("dragleave",function(){o.removeDragAreaStyle(n,i)},false);r.addEventListener("dragenter",function(e){o.stopAll(e);o.addDragAreaStyle(n,i)},false);r.addEventListener("dragleave",function(e){o.stopAll(e);o.removeDragAreaStyle(n,i)},false);r.addEventListener("dragover",function(e){(e.dataTransfer||e.originalEvent.dataTransfer).dropEffect="copy";o.stopAll(e);o.addDragAreaStyle(n,i)},false);r.addEventListener("drop",function(t){o.stopAll(t);o.removeDragAreaStyle(n,i);var a=(t.dataTransfer||t.originalEvent.dataTransfer).files;o.filterFileInfo(Array.from(a),e.type,e.maxSize,false,function(t){if(e.type==o.fileTypeConfig["img"]){e.range&&o.resetScale(e.range,e.fileArea);(function(t){e.callback&&e.callback(t)})(t);e.zoom===true&&o.bindMouseWheel(e.range,e.fileArea)}else{var n={};n[e.fileBtn.attr("name")]=a[0];e.onChange&&e.onChange(t);o.uploadFile(e.fileUploadBtn,undefined,e.url,n,e.progress,e.error,e.success)}})},false)},fileTypeRegExp:function(e,t){var a=new RegExp(".*/(?:"+e+")$","i");return a.test(t)}};t["LjkUpload"]=n})(window,jQuery);